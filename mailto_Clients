Option Explicit

Public licznik As Long
Public apka, nextApka As String

Sub mailto_Clients()
    
    Dim czas As Date
    
    czas = Now()
    
    Dim OA, OM As Object
    
    Dim doKiedy As Date
    Dim i, j, przed, pozycja As Long
    Dim liczbaMaili, iluOdbiorcow As Integer
    Dim zakres, zakres2, tresc, tabelka, adresaci, filename, maile As String
           
    liczbaMaili = 0
    apka = Cells(2, 1)                                                       'STARTUJ OD
    licznik = 2
    
    If sprawdzarka(OA) Then
         Exit Sub
    End If
    
    doKiedy = Zeller(1, True)
    
    'OD TEGO MIEJSCA OPBRÓBKA ADRESÓW
    filename = "\\ispnas2.ad.ing.net\userdata\" & Environ("USERNAME") & "\Downloads\" & "CMDB report ( for MCR).xls"
    Workbooks.Open filename:=filename
    Selection.End(xlDown).Select                                                'usun duplikaty C i D
    zakres = "C2:D" & ActiveCell.Row
    Range(zakres).Select
    ActiveSheet.Range(zakres).RemoveDuplicates Columns:=Array(1, 2), _
        Header:=xlYes
    Selection.End(xlDown).Select
    zakres = "C2:D" & ActiveCell.Row
    Range(zakres).Select
    Range("D2").Activate
    
    ActiveWorkbook.Worksheets("Page 1").Sort.SortFields.Clear                   'posortuj C i D po D
    ActiveWorkbook.Worksheets("Page 1").Sort.SortFields.Add Key:=Range("D2"), _
        SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:=xlSortNormal
    With ActiveWorkbook.Worksheets("Page 1").Sort
        .SetRange Range(zakres)
        .Header = xlNo
        .MatchCase = False
        .Orientation = xlTopToBottom
        .SortMethod = xlPinYin
        .Apply
    End With

    
    '------------
    'usun duplikaty C i D -> [pcjonalnei] sortuj C i D po D  -> jezeli lewy[-4]=apka to -> jezeli C=klient to ->  dla wszystkich lewy[-4]=apka zsumuj z E dla kazdego PRODUKTU z D (czyli lewy[-4] bez koncowek PRD itp.), usun duplikaty z tej sumy
                                
'sprawdz klienta (z danych z tabela przestawna)           'nessus tool np maja wszyscy prawie klienci
    maile = Cells(1124, 5) 'Cells(1124, 5)   'czy na pewno powinno tu byc zakres ???         cells(?,5) to komorka z adresami
                        
    iluOdbiorcow = 0                'zlicza ilosc adresatów danego klienta
    For j = 1 To Len(maile)
        If Mid(maile, j, 1) = "@" Then iluOdbiorcow = iluOdbiorcow + 1
    Next
                        
    For j = 1 To iluOdbiorcow
        przed = pozycja
        pozycja = InStr(pozycja + 1, maile, ",", vbTextCompare)
        If pozycja = 0 Then pozycja = Len(maile)
        Cells(j, 17) = Mid(maile, przed + 1, pozycja - przed)
    Next
    
    zakres2 = "Q1:Q" & iluOdbiorcow
    Range(zakres2).Select                                           'usuwa duplikaty adresów mailowych
    ActiveWorkbook.Worksheets("Page 1").Sort.SortFields.Clear
    ActiveWorkbook.Worksheets("Page 1").Sort.SortFields.Add Key:=Range("Q1"), _
        SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:=xlSortNormal
    With ActiveWorkbook.Worksheets("Page 1").Sort
        .SetRange Range(zakres2)
        .Header = xlNo
        .MatchCase = False
        .Orientation = xlTopToBottom
        .SortMethod = xlPinYin
        .Apply
    End With
    ActiveSheet.Range(zakres2).RemoveDuplicates Columns:=1, Header:=xlNo
   
    For i = 1 To iluOdbiorcow
        adresaci = adresaci + Trim(Replace(Cells(i, 17), ",", ";"))     'dopasowywac an biezaco do danego klienta albo stworzyc statyczna liste adresatów juz obrobionych czyli WYSZUKAJ XXXXXXXXXXX
     
    Next
                                  
    'DO TEGO MIEJSCA OPBRÓBKA ADRESÓW
    
    
    
    
    Do While Cells(licznik, 6) <> ""
    
    Set OA = CreateObject("Outlook.Application")                      'musi byc w petli, zeby poprawnie tworzyl nowe obiekty maili
    Set OM = OA.CreateItem(0)
         
    tabelka = "<table border=1 <B>"
    For i = licznik To i + 1200                                       ' WYMYSLIC SPRAWDZANIE DLUGOSCI TABELI !!!!    vs ile róznych policyname jest -> spr w SQLu (okolo 1062)
        tabelka = tabelka + "<tr><td width=350>" & Cells(i, 1) & "</td><td width=100>" & Cells(i, 2) & "</td></tr>"
        If Cells(i + 1, 6) <> "polityka" Then
            If Cells(i + 1, 6) = "PRODUCT" Then
                nextApka = Cells(i + 1, 1)
                Else:
                i = i + 1
'pobieraj maile i przypisz je potem do zmiennej
                                  'WYSZUKAJ XXXXXXXXXXX
                'sprawdzic czy w tym wypadku zawsze wskazuje na klienta, jesli tak to client=cells(?,1) (np szukaj wstecz(w góre) az do pola client w kolumnie 6 i wczytaj cell z kolumny 1
                                
                                
                                    adresaci = "TOMASZ.WILCZEK@ing.com" & "; ALEKSANDER.SZYDLOWSKI@ing.com"         'zamiana przecinków na sredniki w kolumnie z mailami
'PIERWSZYCH ARRESATÓW NADAC -> ZACZYNAC KOLEJKE OD i=1 (CHYBA) - lub wstawic kilka pustych wierszy od góry - I WCZYTAC OD RAZU JUZ ICH
            End If
            licznik = i + 1
            Exit For
        End If
    Next
    tabelka = tabelka + "</table></B>"
 
    tresc = "Good morning,<br><br>" & _
            "According to the Audit Point CAS_2019_083 and the TSCM Cleaning Plan:<br>" & _
            "The action plan for removing non-compliances detected as part of the compliance monitoring process presents the following steps:<br>" & _
            "   - All ""High""  non-compliances older than 4 months will be remediated, waived or covered by MIA by the end of December 2019.<br>" & _
            "   - All ""Medium"" non-compliances older than 6 months will be remediated, waived or covered by MIA by the end of 2020.<br>" & _
            "   - All ""Low"" non-compliances older than 9 months will be remediated, waived or covered by MIA by the end of 2020.<br><br>" & _
            "Resloving all severities of non-compliances at one time, we will save together a lot of our time.<br><br>" & _
            "I send TSCM quantity of non-compliances on <B>" & apka & "<br>" & tabelka & "<br>" & _
            "A report with the list of non-compliances should be generated on the GSOC portal --> Technical State Compliance Monitoring --> All results --> applied filters:<br>" & _
            "Test state:    " & "<B>FAILED</B><br>" & _
            "Product:       <B>" & apka & "</B><br><br>" & _
            "Please analyze them and give the permission for remediation.<br><br>" & _
            "Waivers based on SOLL, RA or MIA please report using GSOC portal.<br><br>" & _
            "<B>Please give us feedback until " & doKiedy & ". Please note that no answer is automatically an agreement to remediate all the non-compliances.</B><br><br>" & _
            "In case of any doubts or questions, do not hesitate to contact us.<br><br>VIPER-TSCM Team"
                  
    With OM
        .Display                                             'musi byc w tej kolejnosci zeby wyswietlilo stopke
        .To = adresaci                                       'wczytac adresatów
        .CC = "viper.techpl@ing.com"
        '.BCC = ""
        .Subject = "TSCM-HIGH-30.09.2019-" & apka            'DATY POPRAWIAC !!!!!!!!!!
        '.Body = tresc
        .HTMLBody = tresc & vbCrLf & .HTMLBody                '   "<HTML><BODY>OoOOooO </BODY></HTML>" &
    Set .SendUsingAccount = OA.Session.Accounts.Item(2)
        '.Attachments.Add ("C:\plik.txt")
        .Display                                              'aby obejrzec e-mail przed wyslaniem
        '.Send
    End With
    Set OM = Nothing
    Set OA = Nothing
    apka = nextApka
    liczbaMaili = liczbaMaili + 1
    
    Loop
    
    czas = Now() - czas
    
    Set OA = CreateObject("Outlook.Application")
    Set OM = OA.CreateItem(0)
    
    With OM
        .To = "viper.techpl@ing.com"
        .Subject = "Mails sending time"
        .body = "Sending time of " & liczbaMaili & " mails was " & czas & "."
        .Send
    End With
    
    Set OM = Nothing
    Set OA = Nothing
    
End Sub

Function sprawdzarka(aplikacja_outlooka) As Boolean

    Dim kolejny As Byte
        
    Set aplikacja_outlooka = CreateObject("OUTLOOK.Application")
    
  '  For kolejny = 1 To aplikacja_outlooka.Session.Accounts.Count
  '      Debug.Print aplikacja_outlooka.Session.Accounts.Item(kolejny) & vbTab & " ma numer " & kolejny
  '  Next kolejny
    
    If aplikacja_outlooka.Session.Accounts.Item(2) <> "viper.techpl@ing.com" Then
        MsgBox "Mails will be sent from account: " & aplikacja_outlooka.Session.Accounts.Item(2) & vbCrLf
        sprawdzarka = True
    End If

End Function

Function Zeller(tygodnie, Gregorian) As Date

'zwróc date = dzis + 7 (tydzien) + 5 (dopelnienie do nastepnego piatku) i wynik algorytmu '+skorygowac ew o 1 czy 2 zeby dobrze wyliczal

    '(d+=m<3?y--:y-2,23*m/9+d+4+y/4-y/100+y/400)mod7

    Dim d, m, y, s, a, b, c As Byte
    Dim leap As Boolean
    Dim mon(1 To 12) As Byte
    
    'Date() = Volatile

'    d = Day(Date)
'    m = Month(Date)
'    y = Year(Date)
     
 '   mon(1) = 0
 '   mon(2) = 1
 '   mon(3) = 1
 '   mon(4) = 2
 '   mon(5) = 5
 '   mon(6) = 6
 '   mon(7) = 2
 '   mon(8) = 3
 '   mon(9) = 4
 '   mon(10) = 0
 '   mon(11) = 1
 '   mon(12) = 4

'    leap = (Not Gregorian & Not (y Mod 4)) Or (Not Gregorian) & (Not (y Mod 4) & (y Mod 100) Or Not (y Mod 400))
 '   a = (y Mod 100) Mod 28
  '  b = (Not Gregorian) * (4 + (y Mod 700) / 100 + 2 * (a / 4) + 6 * ((Not leap) * (1 + (a Mod 4)) + (leap) * ((9 + m) / 12))) Mod 7 + Gregorian * (2 * (1 + (y Mod 400) / 100 + (a / 4)) + 6 * ((Not leap) * (1 + (a Mod 4)) + (leap) * ((9 + m) / 12))) Mod 7
   ' c = (3 * mon(m - 1) + d) Mod 7
    'Zeller = Date + tygodnie + 5 - (((c + 6 * b) Mod 7) + 1) 'dodalem +1 zeby poniedzialek = 1

Zeller = "2019/10/31"

End Function

Sub db()

       Dim cn As Object, rs As Object, output As String, sql As String
    
    '---Connecting to the Data Source---
    Set cn = CreateObject("ADODB.Connection")
    With cn
        .Provider = "Microsoft.ACE.OLEDB.12.0"
        .ConnectionString = "Data Source=" & ThisWorkbook.Path & "\" & ThisWorkbook.Name & ";" & "Extended Properties=""Excel 12.0 Xml;HDR=YES"";"
        .Open
    End With
    
    
    '---Run the SQL SELECT Query---
    sql = "SELECT * FROM [Sheet1$]"
    Set rs = cn.Execute(sql)
    
    Do
       output = output & rs(0) & ";" & rs(1) & ";" & rs(2) & vbNewLine
       Debug.Print rs(0); ";" & rs(1) & ";" & rs(2)
       rs.Movenext
    Loop Until rs.EOF
    MsgBox output
    
    '---Clean up---
    rs.Close
    cn.Close
    Set cn = Nothing
    Set rs = Nothing
    
End Sub

Sub DEL_WZOR_Mail_Outlook_With_Signature_Html_1()

    Dim OuteApp As Object
    Dim OuteMail As Object
    Dim strbody As String

    Set OuteApp = CreateObject("Outlook.Application")
    Set OuteMail = OuteApp.CreateItem(0)

    'strbody = "<H3><B>Dear Customer Ron de Bruin</B></H3>" & _
              "Please visit this website to download the new version.<br>" & _
              "Let me know if you have problems.<br>" & _
              "<A HREF=""http://www.rondebruin.nl/tips.htm"">Ron's Excel Page</A>" & _
              "<br><br><B>Thank you</B>"

    On Error Resume Next

    With OuteMail
        .Display
        .To = "ron@debruin.nl"
        .CC = ""
        .BCC = ""
        .Subject = "This is the Subject line"
        .HTMLBody = strbody & "<br>" & .HTMLBody
        .Display
    End With

    On Error GoTo 0
    Set OuteMail = Nothing
    Set OuteApp = Nothing
    
End Sub

Sub pobierz_maile()
   ' Dim maile, zakres2, adresaci As String
   ' Dim przed, pozycja, ileMaili As Integer

    
    Dim i As Integer
 
    maile = Cells(1124, 5) 'Cells(1124, 5)   'czy na pewno powinno tu byc zakres ???         cells(?,5) to komorka z adresami
                        
    ileMaili = 0                'zlicza ilosc adresatów danego klienta
    For i = 1 To Len(maile)
        If Mid(maile, i, 1) = "@" Then ileMaili = ileMaili + 1
    Next
                        
    For i = 1 To ileMaili
        przed = pozycja
        pozycja = InStr(pozycja + 1, maile, ",", vbTextCompare)
        If pozycja = 0 Then pozycja = Len(maile)
        Cells(i, 17) = Mid(maile, przed + 1, pozycja - przed)    ' odbiorca(i)
    Next
    
    zakres2 = "Q1:Q" & ileMaili
    Range(zakres2).Select                                           'usuwa duplikaty adresów mailowych
    ActiveWorkbook.Worksheets("Page 1").Sort.SortFields.Clear
    ActiveWorkbook.Worksheets("Page 1").Sort.SortFields.Add Key:=Range("Q1"), _
        SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:=xlSortNormal
    With ActiveWorkbook.Worksheets("Page 1").Sort
        .SetRange Range(zakres2)
        .Header = xlNo
        .MatchCase = False
        .Orientation = xlTopToBottom
        .SortMethod = xlPinYin
        .Apply
    End With
    ActiveSheet.Range(zakres2).RemoveDuplicates Columns:=1, Header:=xlNo
   
    For i = 1 To ileMaili
        adresaci = adresaci + Trim(Replace(Cells(i, 17), ",", ";"))
    Next

End Sub
